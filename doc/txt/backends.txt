.. -*- mode: rst -*-

==================
 Storage Backends
==================

S3QL can use different protocols to store the file system data.
Independent of the backend that you use, the place where your file
system data is being stored is called a *bucket*. (This is mostly for
historical reasons, since initially S3QL supported only the Amazon S3
backend).

The `authinfo` file
===================

Most backends first try to read the file `~/.s3ql/authinfo` to determine
the username and password for connecting to the remote host. If this
fails, both username and password are read from the terminal.

The `authinfo` file has to contain entries of the form ::

  backend <backend> machine <host> login <user> password <password>

So to use the login `joe` with password `jibbadup` when using the FTP
backend to connect to the host `backups.joesdomain.com`, you would
specify ::

  backend ftp machine backups.joesdomain.com login joe password jibbadup

  
Consistency Guarantees
======================
  
The different backends provide different types of *consistency
guarantees*. Informally, a consistency guarantee tells you how fast
the backend will apply changes to the stored data. 

S3QL defines the following three levels:

* **Read-after-Write Consistency.** This is the strongest consistency
  guarantee. If a backend offers read-after-write consistency, it
  guarantees that as soon as you have committed any changes to the
  backend, subsequent requests will take into account these changes.

* **Read-after-Create Consistency.** If a backend provides only
  read-after-create consistency, only the creation of a new object is
  guaranteed to be taken into account for subsequent requests. This
  means that, for example, if you overwrite data in an existing
  object, subsequent requests may still return the old data for a
  certain period of time.

* **Eventual consistency.** This is the lowest consistency level.
  Basically, any changes that you make to the backend may not be
  visible for a certain amount of time after the change has been made.
  However, you are guaranteed that no change will be lost. All changes
  will *eventually* become visible.

  .


As long as your backend provides read-after-write or read-after-create
consistency, you do not have to worry about consistency guarantees at
all. However, if you plan to use a backend with only eventual
consistency, you have to be a bit careful in some situations.


.. _eventual_consistency:

Dealing with Eventual Consistency
---------------------------------

.. NOTE::

  The following applies only to storage backends that do not provide
  read-after-create or read-after-write consistency. Currently,
  this is only the Amazon S3 backend *if used with the US-Standard
  storage region*. If you use a different storage backend, or the S3
  backend with a different storage region, this section does not apply
  to you.

While the file system is mounted, S3QL is able to automatically handle
all issues related to the weak eventual consistency guarantee.
However, some issues may arise during the mount process and when the
file system is checked.

Suppose that you mount the file system, store some new data, delete
some old data and unmount it again. Now remember that eventual
consistency means that there is no guarantee that these changes will
be visible immediately. At least in theory it is therefore possible
that if you mount the file system again, S3QL does not see any of the
changes that you have done and presents you an "old version" of the
file system without them. Even worse, if you notice the problem and
unmount the file system, S3QL will upload the old status (which S3QL
necessarily has to consider as current) and thereby permanently
override the newer version (even though this change may not become
immediately visible either).

The same problem applies when checking the file system. If the backend
provides S3QL with only partially updated data, S3QL has no way to
find out if this a real consistency problem that needs to be fixed or
if it is only a temporary problem that will resolve itself
automatically (because there are still changes that have not become
visible yet).

While this may seem to be a rather big problem, the likelihood of it
to occur is rather low. In practice, most storage providers rarely
need more than a few seconds to apply incoming changes, so to trigger
this problem one would have to unmount and remount the file system in
a very short time window. Many people therefore make sure that they
wait a few minutes between successive mounts (or file system checks)
and decide that the remaining risk is negligible.

Nevertheless, the eventual consistency guarantee does not impose an
upper limit on the time that it may take for change to become visible.
Therefore there is no "totally safe" waiting time that would totally
eliminate this problem; a theoretical possibility always remains.


  

The Amazon S3 Backend
=====================

To store your file system in an Amazon S3 bucket, use a storage URL of
the form `s3://<bucketname>` or `s3rr://<bucketname>`. The later form
will use `reduced redundancy storage
<http://aws.amazon.com/s3/#protecting>`_. In theory you could change
the prefix for a given bucket at will, but you really should not do
this because different parts of your file system would then be stored
with different durability guarantees.

Bucket names must conform to the `S3 Bucket Name Restrictions`_.

The Amazon S3 backend provides read-after-create consistency for the
EU, Asia-Pacific and US-West storage regions. *For the US-Standard
storage region, Amazon S3 provides only eventual consistency* (please
refer to :ref:`eventual_consistency` for information about
what this entails).

When reading the authentication information for the S3 backend from
the `authinfo` file, the `host` field is ignored, i.e. the first entry
with `s3` as a backend will be used. For example ::

   backend s3 machine any myAWSaccessKeyId password myAwsSecretAccessKey

Note that the bucket names come from a global pool, so chances are
that your favorite name has already been taken by another S3 user.
Usually a longer bucket name containing some random numbers, like
`19283712_yourname_s3ql`, will work better. 

If you do not already have one, you need to obtain an Amazon S3
account from `Amazon AWS <http://aws.amazon.com/>`_. The account is
free, you will pay only for the amount of storage that you actually
use.

Note that the login and password for accessing S3 are not the user id
and password that you use to log into the Amazon Webpage, but the "AWS
access key id" and "AWS secret access key" shown under `My
Account/Access Identifiers
<https://aws-portal.amazon.com/gp/aws/developer/account/index.html?ie=UTF8&action=access-key>`_.

.. _`S3 Bucket Name Restrictions`: http://docs.amazonwebservices.com/AmazonS3/2006-03-01/dev/BucketRestrictions.html


The Local Backend
=================

The local backend stores file system data in a directory on your
computer. The storage URL for the local backend has the form
`local://<path>`. Note that you have to write three consecutive
slashes to specify an absolute path, e.g. `local:///var/archive`.

The local backend provides read-after-write consistency.

The SFTP Backend
================

The SFTP backend uses the SFTP protocol, which is a file transfer
protocol similar to ftp, but uses an encrypted SSH connection. 
It provides read-after-write consistency.

Note that the SFTP backend is rather slow and has not been tested
as extensively as the S3 and Local backends.

The storage URL for SFTP connections has the form ::

  sftp://<host>[:port]/<path>

The SFTP backend will always ask you for a password if you haven't
defined one in `~/.s3ql/authinfo`. However, public key authentication
is tried first and the password will only be used if the public key
authentication fails.

The public and private keys will be read from the standard files in
`~/.ssh/`. Note that S3QL will refuse to connect to a computer with
unknown host key; to add the key to your local keyring you have to
establish a connection to that computer with the standard SSH command
line programs first.

